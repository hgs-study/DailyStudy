## 복제

- 복제 기능은 장애 발생 시 빠른 서버 교체나 장비 교체 등에 사용

## 모델

- Master / Slave 형태 복제 모델 제공
- Master의 변경이 Slave로 전파
- 한 대의 Slave는 오직 한 대의 Master만 가질 수 있다
- 슬레이브가 다른 장비의 마스터로도 동작할 수 있다

## 복제 순서

1. 슬레이브에서 slaveof 명령을 이용하여 마스터 서버를 설정
2. 마스터 서버가 설정되면, replicationCron에서 현재 상태에 따라 connectWithMaster를 호출
3. 마스터는 복제를 위해 RDB를 생성한 후 슬레이브에 전송 (새로 들어온 명령들은 처리 후 복제버퍼에 저장) 
4. 슬레이브는 RDB를 로드하고 나머지 차이에 대한 명령(복제버퍼)을 마스터에게 전달 받아 복제 완료

## 부분 동기화(Partial resynchronization)

- 마스터와 복제서버는 각 서버의 run id 와 replication offset을 가지고 있습니다. 마스터와 복제서버간 네트워크가 끊어지면 마스터는 복제서버에 전달할 데이터를 backlog-buffer에 저장합니다. 다시 연결되었을 때 backlog-buffer가 넘치지 않았으면 run id와 offset을 비교해서 그 이후 부터 동기화를 합니다. 이것을 부분 동기화라고 합니다. Backlog-buffer 크기는 `repl-backlog-size` 파라미터로 설정합니다. 부분 동기화 기능은 레디스 버전 2.8 부터 제공됩니다.
- 네크워트 단절 시간이 길어져 마스터의 backlog-buffer가 넘치면 다시 연결되었을 때 전체 동기화(full synchronization)를 합니다. 마스터나 복제서버 중 한쪽이 재시작했을 경우에도 전체 동기화를 합니다.

## 복제 주의사항

### slaveof no one

- 슬레이브는 마스터의 상태를 지속적으로 감시하면서 바뀌는 내용을 계속 전달 받는다. 만약 이상이 발생해서 마스터와 연결이 끊어지면 재접속 시도를 하며, 마스터에서 전체 데이터를 다시 가져와 마스터의 최종 상태로 자신의 데이터를 변경한다.

1. 슬레이브는 마스터의 상태를 지속적으로 체크
2. 마스터와의 연결 상태상 이상을 슬레이브가 감지
    - 마스터 장애, 네트워크 사정으로 연결 장애 등
3. 슬레이브에서 마스터와의 연결상태 복원
4. 마스터에 장애가 발생하여 마스터에 데이터가 하나도 없는 경우에는 슬레이브의 모든 내용이 사라진다
- slaveof no one 명령어
    - 일단 장애 판단 여부는 관리자나 다른 서비스에서 체크할 수 있다고 하고 명시적으로 마스터가 현재 장애가 났다는 걸 알고 있다면, 해당 슬레이브에 “slaveof no one” 명령을 줘서 더 이상 슬레이브로 동작하지 않도록 설정한다.

<br>

### 복제시에 무조건 RDB를 백그라운드로 생성하는 것을 주의

- 복제를 하면, 사용자의 설정과는 무관하게 무조건 슬레이브에 전달할 RDB를 만들기 위해 fork를 해서 RDB를 생성
- 따라서, 하나의 프로세스가 너무 많은 메모리를 사용하지 않도록 나누는 과정 필요


<br>

### Redis 복제를 이용한 실시간 마이그레이션

- 서비스를 운영하다 보면, 현재의 데이터를 더 좋은 장비로 이전해야하는 경우가 생긴다. 가능한 다운타임 ㅇ없이 바로 데이터를 옮기고 싶어하는데, 이때 복제기능을 이용하면 다운 없이 쉽게 데이터를 이전할 수 있다.
1. 데이터 이전을 위한 새로운 Redis 인스턴스 생성
2. 새로운 Redis 인스턴스를 기존 마스터의 슬레이브로 설정
3. 새로운 Redis의 `slave-read-only` 설정을 끈다.
    - 기본적으로 슬레이브는 `slave-read-only` 로 설정돼있는데, 이 기능을 꺼서 슬레이브에서도 업데이트가 가능하도록 설정한다. 다만 슬레이븨 변경이 마스터로 전달되지 않는다.

```bash
config set slave-read-only no
```

4. 클라이언트들이 새로운 Redis 인스턴스를 마스터로 인식하도록 설정 변경
5. `slaveof no one` 명령을 이용해서 새로운 Redis와 기존 마스터 Redis 연결을 종료한다.

```bash
slaveof no one
```

6. 기존 마스터 Redis 제거
