## Kafka

### Kafka 란?
---
```
  - 데이터를 전송하는 소스 애플리케이션과 데이터를 받는 타겟 애플리케이션 중간에서 데이터를 전송해주는 큐 역할을 한다.
  - 카프카는 고가용성으로서 서버가 이슈가 생기거나, 갑작스럽게 랙(전원)이 내려가더라도 데이터를 손실 없이 복구할 수 있다.
  - 애플리케이션 사이에서의 커플링을 낮출 수 있다.
  - 카프카는 링크드인에서 개발했으며 현재는 오픈소스로 사용되어지고 있다.
```

![image](https://user-images.githubusercontent.com/76584547/124613926-b35fae00-deae-11eb-92b9-c359226eb8ee.png)


### 토픽이란?
---
```
  - 카프카 내에서 데이터가 들어가는 공간 (큐)
```

![image](https://user-images.githubusercontent.com/76584547/124615205-00904f80-deb0-11eb-9da4-32755e860f11.png)

<br/>

+ 하나의 토픽(clikc_log)는 여러개의 파티션을 가질 수 있으며 데이터(record)가 쌓임
```
  - 데이터(record)는 내부에서 하나씩 쌓이며, 오래된 순 (0 -> 1 -> 2 -> 3 ...)으로 컨슈머에 전달된다.
  - 6번까지 데이터가 전달된 후 또 다른 데이터가 들어올 때까지 컨슈머는 기다린다.
  - 컨슈머가 record들을 가져가도 데이터는 삭제되지 않고 파티션에 그대로 남게된다.
```
![image](https://user-images.githubusercontent.com/76584547/124616233-dd19d480-deb0-11eb-8cc5-6f0bca9eae4c.png)

<br/>

+ 그대로 남게된 record들은 새로운 컨슈머가 붙었을 때 다시 0번부터 가져가서 사용할 수 있다.
```
  - 다만 컨슈머 그룹이 달라야하고
  - auto.offset.reset = earliest 설정이 되어있어야한다.
  - 동일 데이터를 2번 사용할 수 있다 (카프카를 사용하는 아주 중요한 이유)
    => 클릭로그를 es에 저장해야하고, 하둡에 저장해야하기 때문에
```

![image](https://user-images.githubusercontent.com/76584547/124616766-5285a500-deb1-11eb-80f2-af5142dd225c.png)

<br/>

+ record 적재 (파티션이 여러개일 경우)
```
  1. 키가 null이고, 기본 파티셔너 사용할 경우
    => 라운드 로빈으로 할당
  2. 키가 있고, 기본 파티셔너 사용할 경우
    => 키의 해시(hash)값을 구하고, 특정 파티션에 할당
```

![image](https://user-images.githubusercontent.com/76584547/124617338-d17add80-deb1-11eb-8152-2777c58a1fa2.png)
=> 키가 없을 경우 '7'은 파티션#1에 할당된다.


<br/>

+ 파티션이 여러개일 경우 고민해봐야한다.
```
  - 파티션을 늘릴 수는 있지만 줄일 수는 없다.
  - 파티션을 늘리는 이유?
    => 파티션을 늘리면 컨슈머의 개수를 늘려서 데이터 처리를 분산시킬 수 있기 떄문에
```

<br/>

+ record는 언제 삭제되는가?
```
  - log.retention.ms : 최대 record 보존시간 설정 가능
  - log.retention.byte : 최대 record 보존 크기(byte) 설정 가능
```
